# SS-DMFO 优化方法总结报告

## 一、项目目标

为93,000+用户生成符合真实城市统计特征的轨迹坐标，需要同时满足：
1. **空间约束**：H/W/O各类型的空间分布匹配真实数据
2. **交互约束**：HW/HO/WO共现模式匹配真实数据（稀疏矩阵，HW有103万非零项）

**评估指标**：Jensen-Shannon Divergence (JSD)，越低越好

**Baseline (IPF)**：
- Spatial JSD = 0.0000 (完美)
- Interaction JSD = 0.6348 (需要改善)

---

## 二、方法演进历程

### 2.1 SS-DMFO 1.0/2.0：GPU with top_k (已弃用)

**问题**：`top_k=50`只覆盖2,500个交互位置，真实HW有1,034,099个非零项

---

### 2.2 SS-DMFO 3.0：Sparse (Adam优化器)

基于专家建议，使用SDDMM+SpMM稀疏加速。

**结果**（100用户）：
| 方法 | Spatial JSD | Interaction JSD |
|------|-------------|-----------------|
| IPF | 0.0000 | 0.6348 |
| Sparse-3.0 | 0.1186 | 0.35 (Support) |

**问题**：
1. 空间JSD恶化（0.00 → 0.12）
2. 梯度下降（Adam）的加性更新不稳定
3. α和β更新相互干扰

---

### 2.3 SS-DMFO 4.0：G-IPF (Sinkhorn风格)

根据专家建议，放弃Adam，改用G-IPF（广义迭代比例拟合）。

**核心改变**：
```
Adam:  α ← α - lr * gradient          (加性更新)
G-IPF: α ← α - T * (log μ_real - log μ_gen)  (对数域乘性更新)
```

**实现的功能**：
1. 对数域G-IPF更新（替代Adam）
2. 交替投影（先空间，后交互）
3. 阻尼因子防止震荡
4. Dual-Q策略（空间用alpha-only Q，交互用MFVI Q）
5. 多重采样评估

---

## 三、SS-DMFO 4.0 G-IPF 详细实验

### 3.1 参数扫描结果

测试了8种配置（100用户，100次迭代）：

| Config | alpha_damp | beta_damp | freeze_α | use_β_final | Spatial | Interact |
|--------|------------|-----------|----------|-------------|---------|----------|
| **IPF** | - | - | - | - | **0.0000** | 0.6348 |
| A1_low | 0.05 | 0.01 | True | True | 0.1074 | 0.6347 |
| A2_mid | 0.10 | 0.02 | True | True | 0.1503 | 0.6345 |
| A3_high | 0.20 | 0.05 | True | True | 0.1834 | 0.6346 |
| B1_no_freeze | 0.05 | 0.02 | False | True | 0.1074 | 0.6344 |
| C1_no_beta | 0.10 | 0.02 | True | False | 0.1523 | 0.6341 |
| D1_high_temp | 0.10 | 0.02 | True | True | 0.1946 | 0.6350 |
| E1_more_mfvi | 0.10 | 0.02 | True | True | 0.1503 | 0.6345 |
| F1_balanced | 0.08 | 0.03 | False | True | 0.1665 | 0.6349 |

### 3.2 关键发现

**交互JSD完全没有改善！**

所有G-IPF配置的交互JSD都在0.634-0.635范围，与IPF基线（0.6348）几乎相同。

这意味着：
1. Beta优化**完全无效**
2. MFVI中的beta对最终分配**没有实际影响**
3. 100+小时的实现和调参工作**没有任何收益**

### 3.3 遇到的Bug和修复

1. **符号错误**（严重）
   - 问题：G-IPF更新公式符号方向错误
   - 原因：我们的参数化是 Q ∝ exp(-α/T)，与标准Sinkhorn相反
   - 修复：`α -= T*(log_real - log_gen)` 而非 `+=`

2. **阻尼过大**
   - 问题：damping=0.8导致Spatial JSD跳到log(2)=0.6931
   - 修复：降低到0.05-0.1

3. **交互阶段破坏空间**
   - 问题：即使冻结α，beta通过MFVI改变Q，影响空间统计
   - 尝试的修复：
     - freeze_alpha_in_phase2 → 无效
     - Dual-Q策略（空间用alpha-only Q）→ 无效
     - use_beta_in_final=True → 无效

4. **最终分配未使用beta**
   - 问题：最终分配用`use_beta=False`，优化的beta没被使用
   - 修复：添加`use_beta_in_final`选项
   - 结果：即使使用beta，交互JSD仍无改善

---

## 四、失败原因分析

### 4.1 根本问题：Beta对Q的影响太弱

**MFVI机制**：
```python
# Beta通过局部场影响Q
field = α + Σ β[i,j] * Q_other[j]  # mean field
Q = softmax(-field / T)
```

**问题**：
1. 支撑集非常稀疏（0.06%非零）
2. 大多数位置的beta=0
3. 非零beta的贡献被softmax稀释
4. 最终Q几乎完全由α决定

### 4.2 数学分析

设grid_size = 40,885，support_size = 1,034,099

对于某个H位置h，MFVI局部场：
```
field_h = α_H[h] + Σ_{w∈support_h} β_HW[h,w] * Q_W[w]
```

问题：
- support_h（h连接的w位置数）平均只有 1,034,099 / 40,885 ≈ 25
- Q_W[w] 是概率分布，每个值约 1/40,885 ≈ 2.4e-5
- 即使 β[h,w] = 10，贡献也只有 10 * 25 * 2.4e-5 ≈ 0.006
- 这相比于 α_H[h]（通常是O(1)量级）完全可忽略

**结论**：在当前问题规模下，Beta通过MFVI的间接影响太弱，无法有效改变Q分布。

### 4.3 为什么IPF在空间上完美但交互上失败

IPF只优化空间边际约束：
- 保证 Σ_users Q_H = target_H ✓
- 但不考虑 Q_H 和 Q_W 的联合分布

交互约束需要的是：
- P(H=h, W=w) = Σ_users Q_H[h] * Q_W[w] 匹配 target_HW[h,w]

这是一个**更难的问题**：
- 需要同时控制N个用户的联合分布
- 不同用户的(H,W)位置选择不能独立

---

## 五、方法对比总结

| 版本 | 方法 | Spatial JSD | Interact JSD | 问题 |
|------|------|-------------|--------------|------|
| IPF | Sinkhorn | **0.0000** | 0.6348 | 不考虑交互 |
| 3.0 | Adam + SDDMM/SpMM | 0.1186 | 0.35 (support) | 空间恶化 |
| 4.0 | G-IPF + Dual-Q | 0.1074 | 0.6347 | 交互无改善 |

**结论**：目前没有方法能同时在空间和交互上超越IPF。

---

## 六、代码文件

```
ssdmfo/core/
├── optimizer_sparse.py    # SS-DMFO 3.0 (Adam)
├── optimizer_gipf.py      # SS-DMFO 4.0 (G-IPF)
└── optimizer_gpu.py       # 旧版（已弃用）

测试脚本：
├── test_sparse.py         # 3.0测试
├── test_gipf.py           # 4.0测试
├── test_gipf_quick.py     # 4.0快速测试
└── test_gipf_sweep.py     # 4.0参数扫描

结果：
└── gipf_sweep_20251127_113716.json  # 参数扫描结果
```

---

## 七、给专家团队的问题

1. **Beta通过MFVI的影响是否太弱？**
   - 在grid_size=40885、support稀疏度0.06%的条件下
   - Beta贡献相比Alpha是否可忽略？

2. **是否需要更直接的交互建模？**
   - 当前：β通过mean field间接影响Q
   - 备选：直接在loss中加入交互项？

3. **问题本身是否可解？**
   - IPF已达到空间最优
   - 在保持空间的同时改善交互，数学上是否可行？

4. **是否需要更多用户？**
   - 当前测试只用100用户
   - 稀疏支撑集需要多少用户才能有效覆盖？

5. **深度学习方向是否更有希望？**
   - 输入：用户life pattern
   - 输出：坐标分布
   - 端到端学习空间+交互

---

## 八、关键数据

- 用户数：93,361（测试用100-1000）
- 网格大小：221 × 185 = 40,885
- 支撑集大小：
  - HW: 1,034,099 (0.06%)
  - HO: 3,988,341 (0.24%)
  - WO: 3,975,927 (0.24%)
- 总可能交互位置：40,885² = 1,671,583,225

---

*报告更新日期：2025-11-27*
*作者：SS-DMFO Team*
